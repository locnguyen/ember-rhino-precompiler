importPackage(java.io);

/**
 * This script can be called from the shell if Rhino is on the classpath.
 *
 * java org.mozilla.javascript.tools.shell.Main ember-rhino-precompiler.js
 */
(function(args) {

  var options = {
    envjs: 'http://www.envjs.com/dist/env.rhino.1.2.js',
    jquery: 'http://code.jquery.com/jquery-1.9.1.min.js',
    handlebars: 'https://raw.github.com/wycats/handlebars.js/1.0.0-rc.3/dist/handlebars.js',
    ember: 'https://raw.github.com/emberjs/ember.js/release-builds/ember-1.0.0-rc.1.js',
    templatesDir: null,
    outputDir: null,
    templateExt: 'handlebars'
  };

  function parseArguments(args) {
    if (args.length === 0) return;

    var i, len = args.length, messages = [];

    for (i = 1; i < len; i++) {
      var key = args[i - 1].substring(2);
      options[key] = args[i];
    }

    if (options.templatesDir === null) {
      messages.push('Need --templatesDir');
    }

    if (options.outputDir === null) {
      messages.push('Need --outputDir');
    }

    if (messages.length > 0) {
      print(messages.join('. '));
      java.lang.System.exit(1);
    }
  }

  /** Load the JavaScript libraries in the correct order */
  function loadLibraries() {
    // This prevents 'generated bytecode for method exceeds 64K limit'
    Packages.org.mozilla.javascript.Context.getCurrentContext().setOptimizationLevel(-1);
    load(options.envjs, options.jquery, options.handlebars, options.ember);
  }

  function init() {
    parseArguments(args);

    loadLibraries();
  }
  
  init();
}(arguments));

