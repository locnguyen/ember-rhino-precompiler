importPackage(java.io);

/**
 * This script can be called from the shell if Rhino is on the classpath.
 *
 * java -jar rhino-1.7RV.jar org.mozilla.javascript.tools.shell.Main ember-rhino-precompiler.js 
 */
(function(args) {

  var options = {
    envjs: 'http://www.envjs.com/dist/env.rhino.1.2.js',
    jquery: 'http://code.jquery.com/jquery-1.9.1.min.js',
    handlebars: 'https://raw.github.com/wycats/handlebars.js/1.0.0-rc.3/dist/handlebars.js',
    ember: 'https://raw.github.com/emberjs/ember.js/release-builds/ember-1.0.0-rc.1.js',
    templatesDir: null,
    outputFile: null,
    templateExt: 'handlebars'
  };

  function parseArguments(args) {
    if (args.length === 0) {
      print('No arguments supplied');
      java.lang.System.exit(1);
    }

    var i, len = args.length, messages = [];

    for (i = 1; i < len; i++) {
      var key = args[i - 1].substring(2);
      options[key] = args[i];
    }

    if (options.templatesDir === null) {
      messages.push('Need --templatesDir');
    }

    if (options.outputFile === null) {
      messages.push('Need --outputFile');
    }

    if (messages.length > 0) {
      print(messages.join('. '));
      java.lang.System.exit(1);
    }
  }

  /** Loads the JavaScript libraries in the correct order */
  function loadLibraries() {
    // This prevents 'generated bytecode for method exceeds 64K limit'
    Packages.org.mozilla.javascript.Context.getCurrentContext().setOptimizationLevel(-1);
    load(options.envjs, options.jquery, options.handlebars, options.ember);
  }

  function precompile() {
    var files = new File(options.templatesDir).listFiles(new FilenameFilter({
      accept: function(dir, name) {
        return name.toLowerCase().endsWith(options.templateExt);
      }
    }));

    var i, len = files.length, out = [];

    out.push('(function() {\n');

    for (i = 0; i < len; i++) {
      var tmplFile = files[i],
        tmplName = tmplFile.getName().replaceAll(('\\.' + options.templateExt + '$'), '');
        contents = Ember.Handlebars.precompile(readFile(tmplFile.getAbsolutePath()));
      
      out.push('  Ember.TEMPLATES[\'' + tmplName + '\'] = Ember.Handlebars.template(' + contents + ');\n');
    }

    out.push('}());');
    return out.join('');
  }

  function init() {
    parseArguments(args);
    loadLibraries();

    var outputStream = new BufferedWriter(new FileWriter(options.outputFile));
    outputStream.write(precompile());
    outputStream.close();
  }
  
  init();
}(arguments));

